<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Party Game</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .hidden { display: none; }
    .answers { margin-top: 10px; }
    .answer { padding: 8px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 6px; }
    .btn { padding: 8px 12px; border: 1px solid #333; border-radius: 6px; cursor: pointer; background: #f7f7f7; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    ul { padding-left: 16px; }
    .emoji { font-size: 18px; margin-left: 6px; cursor: pointer; }
    .badge { background: #eee; padding: 4px 8px; border-radius: 12px; }
    .panel { border: 1px solid #ccc; border-radius: 8px; padding: 12px; margin-top: 12px; }
  </style>
</head>
<body>
  <h1>Party Game</h1>

  <!-- –§–û–†–ú–ê –í–•–û–î–ê -->
  <div id="join" class="panel">
    <input id="name" placeholder="–í–∞—à–µ –∏–º—è" />
    <input id="room" placeholder="–ù–æ–º–µ—Ä –∫–æ–º–Ω–∞—Ç—ã" />
    <button id="joinBtn" class="btn">Join Room</button>
  </div>

  <!-- –õ–û–ë–ë–ò / –ò–ì–†–ê -->
  <div id="game" class="panel hidden">
    <div>
      –ö–æ–º–Ω–∞—Ç–∞: <span id="roomNumber" class="badge"></span>
      &nbsp;|&nbsp; –†–∞—É–Ω–¥: <span id="roundNum" class="badge">-</span>
      &nbsp;|&nbsp; <span id="phase" class="badge">Lobby</span>
    </div>

    <h3>–ò–≥—Ä–æ–∫–∏</h3>
    <ul id="players"></ul>

    <button id="startBtn" class="btn hidden">Start Game</button>

    <!-- –ë–ª–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤ -->
    <div id="questionBlock" class="panel hidden">
      <h3>–í–æ–ø—Ä–æ—Å</h3>
      <div id="qText"></div>
      <input id="answerInput" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç..." />
      <button id="sendAnswer" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
      <div id="qNote" style="margin-top:8px;color:#666;"></div>
    </div>

    <!-- –ë–ª–æ–∫ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è -->
    <div id="voteBlock" class="panel hidden">
      <h3>–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ</h3>
      <div id="voteQuestion"></div>
      <div id="voteAnswers" class="answers"></div>
      <div id="voteNote" style="margin-top:8px;color:#666;"></div>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—É–Ω–¥–∞ -->
    <div id="resultsBlock" class="panel hidden">
      <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—É–Ω–¥–∞</h3>
      <div id="leaderboard"></div>
      <button id="nextRoundBtn" class="btn hidden">Next Round</button>
    </div>
  </div>

  <script>
    const BACKEND_URL = "https://party-game-backend-0grh.onrender.com";
    const socket = io(BACKEND_URL, { transports: ['websocket', 'polling'] });

    let myRoom = null;
    let myName = null;
    let myId = null; // –ø—Ä–∏—Å–≤–æ–∏–º –ø—Ä–∏ connect
    let hostId = null;

    // –¢–µ–∫—É—â–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤–æ–ø—Ä–æ—Å/–æ—Ç–≤–µ—Ç
    let currentPairIndex = null;
    let currentQIndex = null;

    // –ö–µ—à –∏–≥—Ä–æ–∫–æ–≤ (–¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–º–µ–Ω)
    let playersCache = [];

    socket.on('connect', () => { myId = socket.id; });

    // ======= UI =======
    const joinDiv = document.getElementById('join');
    const gameDiv = document.getElementById('game');
    const playersUl = document.getElementById('players');
    const startBtn = document.getElementById('startBtn');

    const questionBlock = document.getElementById('questionBlock');
    const qText = document.getElementById('qText');
    const answerInput = document.getElementById('answerInput');
    const sendAnswerBtn = document.getElementById('sendAnswer');
    const qNote = document.getElementById('qNote');

    const voteBlock = document.getElementById('voteBlock');
    const voteQuestion = document.getElementById('voteQuestion');
    const voteAnswers = document.getElementById('voteAnswers');
    const voteNote = document.getElementById('voteNote');

    const resultsBlock = document.getElementById('resultsBlock');
    const leaderboardDiv = document.getElementById('leaderboard');
    const nextRoundBtn = document.getElementById('nextRoundBtn');

    document.getElementById('joinBtn').onclick = () => {
      myName = document.getElementById('name').value.trim();
      myRoom = document.getElementById('room').value.trim();
      if (!myName || !myRoom) {
        alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ –Ω–æ–º–µ—Ä –∫–æ–º–Ω–∞—Ç—ã");
        return;
      }
      socket.emit('joinRoom', { roomId: myRoom, playerName: myName });
    };

    document.getElementById('roomNumber').innerText = '-';

    startBtn.onclick = () => socket.emit('startGame', myRoom);

    // ======= HANDLERS =======
    socket.on('roomJoined', ({ roomId, players, hostId: hId, round, state }) => {
      myRoom = roomId;
      hostId = hId;
      playersCache = players;

      joinDiv.classList.add('hidden');
      gameDiv.classList.remove('hidden');

      document.getElementById('roomNumber').innerText = myRoom;
      document.getElementById('phase').innerText = state;
      document.getElementById('roundNum').innerText = round || 0;

      renderPlayers(players);
      startBtn.classList.toggle('hidden', myId !== hostId);
    });

    socket.on('playerListUpdate', (players) => {
      playersCache = players;
      renderPlayers(players);
    });

    socket.on('hostChanged', (newHostId) => {
      hostId = newHostId;
      startBtn.classList.toggle('hidden', myId !== hostId);
    });

    socket.on('roundStarted', ({ round }) => {
      document.getElementById('roundNum').innerText = round;
      document.getElementById('phase').innerText = 'answering';
      resultsBlock.classList.add('hidden');
      leaderboardDiv.innerHTML = '';
      voteBlock.classList.add('hidden');

      // –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
      questionBlock.classList.add('hidden');
      qText.innerText = '';
      answerInput.value = '';
      qNote.innerText = '';
      currentPairIndex = null;
      currentQIndex = null;
    });

    // –ü–æ–∫–∞–∑ –≤–æ–ø—Ä–æ—Å–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø–∞—Ä—ã
    socket.on('showQuestion', ({ pairIndex, qIndex, question }) => {
      currentPairIndex = pairIndex;
      currentQIndex = qIndex;

      questionBlock.classList.remove('hidden');
      qText.innerText = question;
      answerInput.value = '';
      qNote.innerText = `–í—ã –æ—Ç–≤–µ—á–∞–µ—Ç–µ –∫–∞–∫ —É—á–∞—Å—Ç–Ω–∏–∫ –ø–∞—Ä—ã. –í–æ–ø—Ä–æ—Å ${qIndex + 1} –∏–∑ 2.`;
    });

    sendAnswerBtn.onclick = () => {
      const val = answerInput.value.trim();
      if (!val) return;
      if (currentPairIndex === null || currentQIndex === null) return;

      socket.emit('submitAnswer', {
        roomId: myRoom,
        pairIndex: currentPairIndex,
        qIndex: currentQIndex,
        answer: val
      });

      // –±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å
      answerInput.disabled = true;
      sendAnswerBtn.disabled = true;
      qNote.innerText = '–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –û–∂–∏–¥–∞–π—Ç–µ.';
      setTimeout(() => {
        answerInput.disabled = false;
        sendAnswerBtn.disabled = false;
      }, 1500);
    };

    // –§–∞–∑–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
    socket.on('votingPhaseStarted', () => {
      document.getElementById('phase').innerText = 'voting';
      questionBlock.classList.add('hidden');
      voteBlock.classList.remove('hidden');
      voteAnswers.innerHTML = '';
      voteQuestion.innerText = '–ü–æ–¥–æ–∂–¥–∏—Ç–µ, –∏–¥—ë—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞‚Ä¶';
      voteNote.innerText = '';
    });

    // –®–∞–≥ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è: –ø–∞—Ä–∞+–≤–æ–ø—Ä–æ—Å
    socket.on('votingStep', ({ pairIndex, qIndex, question, answers, eligibleVoters }) => {
      voteAnswers.innerHTML = '';
      voteQuestion.innerText = `–í–æ–ø—Ä–æ—Å: ${question}`;
      const iAmEligible = eligibleVoters.includes(myId);

      if (!iAmEligible) {
        voteNote.innerText = '–í—ã —É—á–∞—Å—Ç–Ω–∏–∫ —ç—Ç–æ–π –ø–∞—Ä—ã ‚Äî –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å –Ω–µ–ª—å–∑—è.';
      } else {
        voteNote.innerText = '–í—ã–±–µ—Ä–∏—Ç–µ –ª—É—á—à–∏–π –æ—Ç–≤–µ—Ç –∏ –ø–æ—Å—Ç–∞–≤—å—Ç–µ —ç–º–æ–¥–∑–∏ (–æ–¥–∏–Ω –≥–æ–ª–æ—Å).';
      }

      answers.forEach(a => {
        const div = document.createElement('div');
        div.className = 'answer';
        div.innerHTML = `
          <b>${a.playerName}</b>: ${a.answer}
          <div style="margin-top:6px;">
            <button class="btn voteBtn" data-target="${a.playerId}" data-emoji="üòÇ">üòÇ</button>
            <button class="btn voteBtn" data-target="${a.playerId}" data-emoji="üôÇ">üôÇ</button>
            <button class="btn voteBtn" data-target="${a.playerId}" data-emoji="üí©">üí©</button>
          </div>
        `;
        voteAnswers.appendChild(div);
      });

      // –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
      [...document.querySelectorAll('.voteBtn')].forEach(btn => {
        btn.onclick = () => {
          if (!eligibleVoters.includes(myId)) return; // –∑–∞—â–∏—Ç–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
          const target = btn.getAttribute('data-target');
          const emoji = btn.getAttribute('data-emoji');
          // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≥–æ–ª–æ—Å
          socket.emit('submitVote', {
            roomId: myRoom,
            pairIndex,
            qIndex,
            targetPlayerId: target,
            emoji
          });
          // –∑–∞–ø—Ä–µ—Ç–∏–º –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ
          [...document.querySelectorAll('.voteBtn')].forEach(b => b.disabled = true);
          voteNote.innerText = '–ì–æ–ª–æ—Å —É—á—Ç—ë–Ω. –û–∂–∏–¥–∞–µ–º –¥—Ä—É–≥–∏—Ö.';
        };
      });
    });

    // (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π –ø–æ–¥—Å—á—ë—Ç
    socket.on('votingStepTally', ({ pairIndex, qIndex, votes }) => {
      // –ú–æ–∂–Ω–æ —á—Ç–æ-—Ç–æ –ø–æ–∫–∞–∑–∞—Ç—å, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
      // console.log('Tally', pairIndex, qIndex, votes);
    });

    // –ò—Ç–æ–≥–∏ —Ä–∞—É–Ω–¥–∞
    socket.on('roundResults', ({ round, leaderboard, totalRounds }) => {
      document.getElementById('phase').innerText = 'results';
      voteBlock.classList.add('hidden');
      resultsBlock.classList.remove('hidden');

      let html = `<table border="1" cellpadding="6" cellspacing="0">
        <tr><th>#</th><th>–ò–≥—Ä–æ–∫</th><th>üòÇ</th><th>üôÇ</th><th>üí©</th></tr>`;
      leaderboard.forEach((row, idx) => {
        html += `<tr>
          <td>${idx + 1}</td>
          <td>${row.name}</td>
          <td>${row.laugh}</td>
          <td>${row.smile}</td>
          <td>${row.poop}</td>
        </tr>`;
      });
      html += `</table>`;
      leaderboardDiv.innerHTML = html;

      // –ö–Ω–æ–ø–∫–∞ —Ä—É—á–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Ä–∞—É–Ω–¥—É (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
      const isHost = (myId === hostId);
      nextRoundBtn.classList.toggle('hidden', !(isHost && round < totalRounds));
      nextRoundBtn.onclick = () => socket.emit('nextRound', myRoom);
    });

    socket.on('gameFinished', ({ leaderboard }) => {
      document.getElementById('phase').innerText = 'finished';
      resultsBlock.classList.remove('hidden');
      let html = `<h3>–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞</h3>
        <table border="1" cellpadding="6" cellspacing="0">
        <tr><th>#</th><th>–ò–≥—Ä–æ–∫</th><th>üòÇ</th><th>üôÇ</th><th>üí©</th></tr>`;
      leaderboard.forEach((row, idx) => {
        html += `<tr>
          <td>${idx + 1}</td>
          <td>${row.name}</td>
          <td>${row.laugh}</td>
          <td>${row.smile}</td>
          <td>${row.poop}</td>
        </tr>`;
      });
      html += `</table>`;
      leaderboardDiv.innerHTML = html;
      voteBlock.classList.add('hidden');
      questionBlock.classList.add('hidden');
    });

    // ====== HELPERS ======
    function renderPlayers(players) {
      playersUl.innerHTML = '';
      players.forEach(p => {
        const li = document.createElement('li');
        li.textContent = p.name + (p.id === hostId ? ' (host)' : '');
        playersUl.appendChild(li);
      });
    }
  </script>
</body>
</html>
